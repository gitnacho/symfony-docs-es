
<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Cómo probar repositorios Doctrine &mdash; Manual de Symfony2 en Español</title>
    
    <link rel="stylesheet" href="../../_static/tnp.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.0.12',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <link rel="shortcut icon" href="../../_static/icotnp.ico"/>
    <link rel="top" title="Manual de Symfony2 en Español" href="../../index.html" />
    <link rel="up" title="Probando" href="index.html" />
    <link rel="next" title="Seguridad" href="../security/index.html" />
    <link rel="prev" title="Cómo utilizar el generador de perfiles en una prueba funcional" href="profiling.html" /> 
  </head>
  <body>
  <div class="imalogo">
    
  <a href="../../index.html"><img src="http://gitnacho.github.com/tnp/img/sf/logo-big.gif" alt="Edición estándar de Symfony2" />
  
    <a href="http://gitnacho.github.com/tnp/"><img src="http://gitnacho.github.com/tnp/_static/normaltnp.png" alt="Traducciones de Nacho Pacheco" /></a>
    <div class="social">
      <a href="https://twitter.com/share" class="twitter-share-button" data-via="esymfony" data-lang="es">Tweet</a>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </div>
    <div id="searchbox">
      <form class="searc " action="../../search.html" method="get">
      <input type="search" name="q" placeholder="Término a buscar" />
      <input type="submit" value="Ir" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
    

    
    <div class="related">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="../security/index.html" title="Seguridad"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="profiling.html" title="Cómo utilizar el generador de perfiles en una prueba funcional"
             accesskey="P">anterior</a> |</li>
        <li><a href="../../index.html">en Español</a> &raquo;</li>
          <li><a href="../index.html" >Recetario</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Probando</a> &raquo;</li> 
      </ul>
    </div>
  </div>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="como-probar-repositorios-doctrine">
<span id="index-0"></span><h1>Cómo probar repositorios <em>Doctrine</em><a class="headerlink" href="#como-probar-repositorios-doctrine" title="Enlazar permanentemente con este título">¶</a></h1>
<p>Las pruebas unitarias de repositorios <em>Doctrine</em> en un proyecto <em>Symfony</em> no son una tarea sencilla. De hecho, para cargar un repositorio es necesario cargar tus entidades, un gestor de entidades, y algunas otras cosas como una conexión.</p>
<p>Para probar tu repositorio, tienes dos diferentes opciones:</p>
<ol class="arabic simple">
<li><strong>Prueba funcional</strong>: Esta incluye usar una conexión de base de datos concreta con objetos de la base de datos real. Es fácil instalarla y puedes probar cualquier cosa, pero es de muy lenta ejecución. Consulta <a class="reference internal" href="#cookbook-doctrine-repo-functional-test"><em>Probando la funcionalidad</em></a>.</li>
<li><strong>Prueba unitaria</strong>: La prueba unitaria se ejecuta más rápido y es más precisa en la forma de probar. Esta requiere una configuración un poco más pequeña, la cual cubre este documento. También puedes probar sólo los métodos que, por ejemplo, crean consultas, no los métodos que se ejecutan realmente.</li>
</ol>
<div class="section" id="pruebas-unitarias">
<h2>Pruebas unitarias<a class="headerlink" href="#pruebas-unitarias" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Puesto que <em>Symfony</em> y <em>Doctrine</em> comparten la misma plataforma de pruebas, es muy fácil implementar las pruebas unitarias en tu proyecto <em>Symfony</em>. El <em>ORM</em> viene con su propio conjunto de herramientas para facilitar las pruebas unitarias y simular todo lo que necesites, tal como una conexión, un gestor de entidades, etc. Al usar los componentes de prueba proporcionados por <em>Doctrine</em> &#8212;junto con algunas configuraciones básicas&#8212; puedes aprovechar las herramientas de <em>Doctrine</em> para las pruebas unitarias de tus repositorios.</p>
<p>Ten en cuenta que si deseas probar la ejecución real de tus consultas, necesitarás una prueba funcional (consulta <a class="reference internal" href="#cookbook-doctrine-repo-functional-test"><em>Probando la funcionalidad</em></a>).
Las pruebas unitarias sólo son posibles cuando pruebas un método que construye una consulta.</p>
<div class="section" id="configurando">
<h3>Configurando<a class="headerlink" href="#configurando" title="Enlazar permanentemente con este título">¶</a></h3>
<p>En primer lugar, necesitas agregar el espacio de nombres <tt class="docutils literal"><span class="pre">Doctrine\Tests</span></tt> a tu cargador automático:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/autoload.php</span>
<span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">registerNamespaces</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="c1">//...</span>
    <span class="s1">&#39;Doctrine\\Tests&#39;</span>                <span class="o">=&gt;</span> <span class="nx">__DIR__</span><span class="o">.</span><span class="s1">&#39;/../vendor/doctrine/orm/tests&#39;</span><span class="p">,</span>
<span class="p">));</span>
</pre></div>
</div>
<p>En seguida, tendrás que configurar un gestor de entidades en cada prueba para que <em>Doctrine</em> pueda cargar entidades y repositorios por ti.</p>
<p>Debido a que <em>Doctrine</em> por omisión no es capaz de cargar los metadatos de anotaciones desde tus entidades, tendrás que configurar el lector de anotaciones para que pueda analizar y cargar las entidades:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Acme/ProductBundle/Tests/Entity/ProductRepositoryTest.php</span>

<span class="k">namespace</span> <span class="nx">Acme\ProductBundle\Tests\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\Tests\OrmTestCase</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\Common\Annotations\AnnotationReader</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping\Driver\DriverChain</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping\Driver\AnnotationDriver</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ProductRepositoryTest</span> <span class="k">extends</span> <span class="nx">OrmTestCase</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @var \Doctrine\Tests\Mocks\EntityManagerMock</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$em</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * {@inheritDoc}</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">setUp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AnnotationReader</span><span class="p">();</span>
        <span class="nv">$reader</span><span class="o">-&gt;</span><span class="na">setIgnoreNotImportedAnnotations</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
        <span class="nv">$reader</span><span class="o">-&gt;</span><span class="na">setEnableParsePhpImports</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

        <span class="nv">$metadataDriver</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AnnotationDriver</span><span class="p">(</span>
            <span class="nv">$reader</span><span class="p">,</span>
            <span class="c1">// proporciona el espacio de nombres de las entidades que</span>
            <span class="c1">// quieres probar</span>
            <span class="s1">&#39;Acme\\ProductBundle\\Entity&#39;</span>
        <span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">em</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_getTestEntityManager</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">em</span><span class="o">-&gt;</span><span class="na">getConfiguration</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">setMetadataDriverImpl</span><span class="p">(</span><span class="nv">$metadataDriver</span><span class="p">);</span>

        <span class="c1">// te permite usar la sintaxis del AcmeStoreBundle:Product</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">em</span><span class="o">-&gt;</span><span class="na">getConfiguration</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">setEntityNamespaces</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;AcmeStoreBundle&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Acme\\StoreBundle\\Entity&#39;</span>
        <span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Si te fijas en el código, notarás que:</p>
<ul class="simple">
<li>Extiendes desde <tt class="docutils literal"><span class="pre">\Doctrine\Tests\OrmTestCase</span></tt>, el cual proporciona útiles métodos para las pruebas unitarias;</li>
<li>Debes configurar el <tt class="docutils literal"><span class="pre">AnnotationReader</span></tt> para poder analizar y cargar las entidades;</li>
<li>Creas el gestor de entidades llamando a <tt class="docutils literal"><span class="pre">_getTestEntityManager</span></tt>, el cual devuelve un gestor de entidades simulado con una conexión simulada.</li>
</ul>
<p>¡Eso es todo! Ya estás listo para escribir las pruebas unitarias para tus repositorios de <em>Doctrine</em>.</p>
</div>
<div class="section" id="escribiendo-tus-pruebas-unitarias">
<h3>Escribiendo tus pruebas unitarias<a class="headerlink" href="#escribiendo-tus-pruebas-unitarias" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Recuerda que los métodos de repositorio de <em>Doctrine</em> sólo pueden probar si estás construyendo y devolviendo una consulta (pero no ejecutando una consulta realmente). Tomemos el siguiente ejemplo:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Acme/StoreBundle/Entity/ProductRepository.php</span>

<span class="k">namespace</span> <span class="nx">Acme\StoreBundle\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityRepository</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ProductRepository</span> <span class="k">extends</span> <span class="nx">EntityRepository</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @param  string $name</span>
<span class="sd">     * @return \Doctrine\ORM\QueryBuilder</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">createSearchByNameQueryBuilder</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span>
            <span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;p.name LIKE :name&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span>
        <span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>En este ejemplo, el método devuelve una instancia de <tt class="docutils literal"><span class="pre">QueryBuilder</span></tt>. Puedes probar el resultado de este método en una variedad de maneras:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Acme/StoreBundle/Tests/Entity/ProductRepositoryTest.php</span>

<span class="cm">/* ... */</span>

<span class="k">class</span> <span class="nc">ProductRepositoryTest</span> <span class="k">extends</span> <span class="nx">OrmTestCase</span>
<span class="p">{</span>
    <span class="cm">/* ... */</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testCreateSearchByNameQueryBuilder</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$queryBuilder</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">em</span>
            <span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;AcmeStoreBundle:Product&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">createSearchByNameQueryBuilder</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="p">;</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;p.name LIKE :name&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$queryBuilder</span><span class="o">-&gt;</span><span class="na">getDqlPart</span><span class="p">(</span><span class="s1">&#39;where&#39;</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;foo&#39;</span><span class="p">),</span> <span class="nv">$queryBuilder</span><span class="o">-&gt;</span><span class="na">getParameters</span><span class="p">());</span>
    <span class="p">}</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>En esta prueba, diseccionas el objeto <tt class="docutils literal"><span class="pre">QueryBuilder</span></tt>, buscando que cada parte sea como tú esperas. Si estuvieras agregando otras cosas al generador de consultas, podrías verificar las partes <em>DQL</em>: <tt class="docutils literal"><span class="pre">select</span></tt>, <tt class="docutils literal"><span class="pre">from</span></tt>, <tt class="docutils literal"><span class="pre">join</span></tt>, <tt class="docutils literal"><span class="pre">set</span></tt>, <tt class="docutils literal"><span class="pre">groupBy</span></tt>, <tt class="docutils literal"><span class="pre">having</span></tt> u <tt class="docutils literal"><span class="pre">orderBy</span></tt>.</p>
<p>Si sólo tienes un objeto <tt class="docutils literal"><span class="pre">Query</span></tt> crudo o prefieres probar la consulta real, puedes probar la cadena de consulta <em>DQL</em> directamente:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="k">public</span> <span class="k">function</span> <span class="nf">testCreateSearchByNameQueryBuilder</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$queryBuilder</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">em</span>
        <span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;AcmeStoreBundle:Product&#39;</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">createSearchByNameQueryBuilder</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
    <span class="p">;</span>

    <span class="nv">$dql</span> <span class="o">=</span> <span class="nv">$queryBuilder</span><span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getDql</span><span class="p">();</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span>
        <span class="s1">&#39;SELECT p FROM Acme\StoreBundle\Entity\Product p WHERE p.name LIKE :name&#39;</span><span class="p">,</span>
        <span class="nv">$dql</span>
    <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="probando-la-funcionalidad">
<span id="cookbook-doctrine-repo-functional-test"></span><h2>Probando la funcionalidad<a class="headerlink" href="#probando-la-funcionalidad" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Si realmente necesitas ejecutar una consulta, tendrás que arrancar el <tt class="docutils literal"><span class="pre">núcleo</span></tt> para conseguir una conexión válida. En este caso, debes extender a <tt class="docutils literal"><span class="pre">WebTestCase</span></tt>, el cual hace todo esto muy fácil:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Acme/StoreBundle/Tests/Entity/ProductRepositoryFunctionalTest.php</span>

<span class="k">namespace</span> <span class="nx">Acme\StoreBundle\Tests\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Test\WebTestCase</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ProductRepositoryFunctionalTest</span> <span class="k">extends</span> <span class="nx">WebTestCase</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @var \Doctrine\ORM\EntityManager</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$em</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$kernel</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="na">createKernel</span><span class="p">();</span>
        <span class="nv">$kernel</span><span class="o">-&gt;</span><span class="na">boot</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">em</span> <span class="o">=</span> <span class="nv">$kernel</span><span class="o">-&gt;</span><span class="na">getContainer</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;doctrine.orm.entity_manager&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testProductByCategoryName</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$results</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">em</span>
            <span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;AcmeStoreBundle:Product&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">searchProductsByNameQuery</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">getResult</span><span class="p">()</span>
        <span class="p">;</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertCount</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$results</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <a href="https://github.com/symfony/symfony-standard"><img style="position: fixed; top: 0; right: 0; border: 0;" src="http://gitnacho.github.com/tnp/img/comun/bifurcame.png" alt="Bifúrcame en GitHub" /></a>
  
  <div style="width:740px;margin:10px auto;">
    
    <div class="related">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="../security/index.html" title="Seguridad"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="profiling.html" title="Cómo utilizar el generador de perfiles en una prueba funcional"
             >anterior</a> |</li>
        <li><a href="../../index.html">en Español</a> &raquo;</li>
          <li><a href="../index.html" >Recetario</a> &raquo;</li>
          <li><a href="index.html" >Probando</a> &raquo;</li> 
      </ul>
    </div>
  </div>


   <div style="width: 740px; margin: 0 auto;">
     <div id="disqus_thread"></div>
     
    <div class="footer">
        &copy; Copyright 2011-2012, Traducido por Nacho Pacheco.
      Actualizado por última vez en Apr 28, 2012.
      Creado con <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
   </div>
   <script type="text/javascript">
    var disqus_shortname = 'documentos-mx';
    var disqus_developer = 1;
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
   </script>
   <noscript>
     Por favor activa JavaScript para ver los <a href="http://disqus.com/?ref_noscript">comentarios accionados por Disqus.</a>
   </noscript>

  </body>
</html>